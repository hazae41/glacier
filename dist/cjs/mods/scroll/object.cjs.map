{"version":3,"file":"object.cjs","sources":["../../../../src/mods/scroll/object.ts"],"sourcesContent":["import { Core } from \"mods/core.js\";\nimport { Fetcher } from \"mods/types/fetcher.js\";\nimport { Mutator } from \"mods/types/mutator.js\";\nimport { Object } from \"mods/types/object.js\";\nimport { Params } from \"mods/types/params.js\";\nimport { Scroller } from \"mods/types/scroller.js\";\nimport { State } from \"mods/types/state.js\";\nimport { DEFAULT_SERIALIZER } from \"mods/utils/defaults.js\";\n\nexport function getScrollStorageKey<D = any, E = any, K = any>(key: K, params: Params) {\n  if (key === undefined)\n    return undefined\n  if (typeof key === \"string\")\n    return key\n\n  const {\n    serializer = DEFAULT_SERIALIZER\n  } = params\n\n  return `scroll:${serializer.stringify(key)}`\n}\n\n/**\n * Non-React version of ScrollHandle\n */\nexport class ScrollObject<D = any, E = any, K = any> implements Object<D[], E, K> {\n  readonly key: K | undefined\n  readonly skey: string | undefined\n  readonly mparams: Params<D[], E, K>\n\n  private _init: Promise<void> | undefined\n  private _state: State<D[], E, K> | undefined | null\n\n  constructor(\n    readonly core: Core,\n    readonly scroller: Scroller<D, E, K>,\n    readonly fetcher: Fetcher<D, E, K> | undefined,\n    readonly params: Params<D[], E, K> = {},\n  ) {\n    this.mparams = { ...core.params, ...params }\n\n    this.key = scroller()\n    this.skey = getScrollStorageKey(this.key, this.mparams)\n\n    this.loadSync()\n    this.subscribe()\n  }\n\n  get init() { return this._init }\n  get state() { return this._state }\n  get ready() { return this._state !== null }\n\n  private loadSync() {\n    const { core, skey, mparams } = this\n\n    this._state = core.getSync(skey, mparams)\n  }\n\n  private async loadAsync() {\n    if (this.ready) return\n\n    const { core, skey, mparams } = this\n\n    this._state = await core.get(skey, mparams)\n  }\n\n  private subscribe() {\n    const { core, skey } = this\n\n    const setter = (state?: State<D[], E, K>) =>\n      this._state = state\n\n    core.on(skey, setter)\n\n    new FinalizationRegistry(() => {\n      core.off(skey, setter)\n    }).register(this, undefined)\n  }\n\n  async mutate(mutator: Mutator<D[], E, K>) {\n    const { core, skey, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n\n    return this._state = await core.mutate(skey, this._state, mutator, mparams)\n  }\n\n  async fetch(aborter?: AbortController) {\n    const { core, scroller, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n    if (fetcher === undefined)\n      return this._state\n\n    return this._state = await core.scroll.first(skey, scroller, fetcher, aborter, mparams)\n  }\n\n  async refetch(aborter?: AbortController) {\n    const { core, scroller, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n    if (fetcher === undefined)\n      return this._state\n\n    return this._state = await core.scroll.first(skey, scroller, fetcher, aborter, mparams, true, true)\n  }\n\n  async scroll(aborter?: AbortController) {\n    const { core, scroller, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n    if (fetcher === undefined)\n      return this._state\n\n    return this._state = await core.scroll.scroll(skey, scroller, fetcher, aborter, mparams, true, true)\n  }\n\n  async clear() {\n    const { core, skey, mparams } = this\n\n    await core.delete(skey, mparams)\n    delete this._state\n  }\n}"],"names":["DEFAULT_SERIALIZER","__assign"],"mappings":"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"}