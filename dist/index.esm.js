import*as t from"react";import{createContext as e,useContext as r,useRef as n,useEffect as i,useMemo as o,useState as u,useCallback as s}from"react";function a(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}var c=function(t,e){return(c=Object.setPrototypeOf||a({__proto__:[]},Array)&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};function l(t,e){var r=function(){this.constructor=t};if("function"!=typeof e&&null!==e)throw TypeError("Class extends value "+String(e)+" is not a constructor or null");c(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var f=function(){return(f=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function d(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&0>e.indexOf(n)&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)0>e.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function h(t,e,r,n){var i=function(t){return a(t,r)?t:new r(function(e){e(t)})};return new(r||(r=Promise))(function(r,o){var u=function(t){try{a(n.next(t))}catch(e){o(e)}},s=function(t){try{a(n.throw(t))}catch(e){o(e)}},a=function(t){t.done?r(t.value):i(t.value).then(u,s)};a((n=n.apply(t,e||[])).next())})}function v(t,e){var r,n,i,o,u=function(t){return function(e){return s([t,e])}},s=function(o){if(r)throw TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(u){o=[6,u],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}},a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o}function p(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function y(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),u=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)u.push(n.value)}catch(s){i={error:s}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return u}function m(t,e,r){if(r||2===arguments.length)for(var n,i=0,o=e.length;i<o;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))}function b(t){var e=function(e){n[e]=t[e]&&function(n){return new Promise(function(i,o){r(i,o,(n=t[e](n)).done,n.value)})}},r=function(t,e,r,n){Promise.resolve(n).then(function(e){t({value:e,done:r})},e)};if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var n,i=t[Symbol.asyncIterator];return i?i.call(t):(t=p(t),n={},e("next"),e("throw"),e("return"),n[Symbol.asyncIterator]=function(){return this},n)}var w=function(){var t=function(){this.map=new Map};return t.prototype.get=function(t){return this.map.get(t)},t.prototype.push=function(t,e){var r=this.map.get(t);r?r.push(e):this.map.set(t,[e])},t.prototype.erase=function(t,e){var r=this.map.get(t);if(r){var n=r.filter(function(t){return t!==e});n.length?this.map.set(t,n):this.map.delete(t)}},t}(),g=function(){var t=function(){this.listeners=new w};return t.prototype.publish=function(t,e){var r,n,i=this.listeners.get(t);if(i)try{for(var o=p(i),u=o.next();!u.done;u=o.next())(0,u.value)(e)}catch(s){r={error:s}}finally{try{u&&!u.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}},t.prototype.on=function(t,e){this.listeners.push(t,e)},t.prototype.off=function(t,e){this.listeners.erase(t,e)},t}();function S(t){if(t.length)return t[t.length-1]}function k(t){if(-1!==t)return Date.now()+t}function x(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}var _=function(t){var e=function(e){return t.call(this,"Aborted: ".concat(e.reason),{cause:e})||this};return l(e,t),e}(Error);function E(t){return!!(x(t,_)||x(t,DOMException)&&"AbortError"===t.name)}var O=function(t){return t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};function D(t,e){return t===e}function A(t,e){return t===e||(void 0===t?"undefined":O(t))===(void 0===e?"undefined":O(e))&&JSON.stringify(t)===JSON.stringify(e)}function I(t,e){if(t===e)return!0;if((void 0===t?"undefined":O(t))!==(void 0===e?"undefined":O(e)))return!1;var r,n,i=Object.keys(t),o=Object.keys(e);if(i.length!==o.length)return!1;try{for(var u=p(i),s=u.next();!s.done;s=u.next()){var a=s.value;if(t[a]!==e[a])return!1}}catch(c){r={error:c}}finally{try{s&&!s.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}return!0}var N=A,P=JSON,j=1e3,T=-1,L=5e3,R=function(){var t=function(t){this.core=t};return t.prototype.first=function(t,e,r,n,i,o,u){var s;return void 0===n&&(n=new AbortController),void 0===i&&(i={}),void 0===o&&(o=!1),void 0===u&&(u=!1),h(this,void 0,void 0,function(){var a,c,l,d,p,y,m,b,w,g,S,x,E,O,D,A,I,P,R,z,C,U,B,F,M,J,q=this;return v(this,function(W){switch(W.label){case 0:if(void 0===t)return[2];return[4,this.core.lock(t,function(){return h(q,void 0,void 0,function(){var r,s;return v(this,function(a){switch(a.label){case 0:return[4,this.core.get(t,i)];case 1:if((null==(r=a.sent())?void 0:r.optimistic)||(null==r?void 0:r.aborter)&&!o||((null==r?void 0:r.aborter)&&o&&r.aborter.abort("Replaced"),this.core.shouldCooldown(r)&&!u||void 0===(s=e(void 0))))return[2,{current:r,skip:!0}];return[4,this.core.mutate(t,r,function(t){return{time:null==t?void 0:t.time,aborter:n}},i)];case 2:return[2,{current:r=a.sent(),first:s}]}})})})];case 1:if(c=(a=W.sent()).current,l=a.skip,d=a.first,l)return[2,c];if(void 0===d)throw Error("Undefined first");y=void 0===(p=i.equals)?N:p,b=void 0===(m=i.cooldown)?j:m,g=void 0===(w=i.expiration)?T:w,x=void 0===(S=i.timeout)?L:S,E=setTimeout(function(){n.abort("First timed out")},x),W.label=2;case 2:return W.trys.push([2,8,11,12]),[4,r(d,{signal:O=n.signal})];case 3:if(A=(D=W.sent()).data,I=D.error,R=void 0===(P=D.time)?Date.now():P,C=void 0===(z=D.cooldown)?k(b):z,B=void 0===(U=D.expiration)?k(g):U,O.aborted)throw new _(O);return[4,this.core.get(t,i)];case 4:if(c=W.sent(),F={},void 0!==A&&(F.data=[A]),F.error=I,!(void 0!==A))return[3,6];return[4,this.core.normalize(!0,{data:[A]},i)];case 5:y(null==(M=W.sent())?void 0:M[0],null===(s=null==c?void 0:c.data)||void 0===s?void 0:s[0])&&delete F.data,W.label=6;case 6:return[4,this.core.mutate(t,c,function(){return f({time:R,cooldown:C,expiration:B,aborter:void 0},F)},i)];case 7:case 10:return[2,W.sent()];case 8:return J=W.sent(),[4,this.core.get(t,i)];case 9:if((null==(c=W.sent())?void 0:c.aborter)!==n)return[2,c];return[4,this.core.mutate(t,c,function(){return{aborter:void 0,error:J}},i)];case 11:return clearTimeout(E),[7];case 12:return[2]}})})},t.prototype.scroll=function(t,e,r,n,i,o,u){var s;return void 0===n&&(n=new AbortController),void 0===i&&(i={}),void 0===o&&(o=!1),void 0===u&&(u=!1),h(this,void 0,void 0,function(){var a,c,l,d,p,b,w,g,x,E,O,D,A,I,N,P,R,z,C,U,B,F,M,J=this;return v(this,function(q){switch(q.label){case 0:if(void 0===t)return[2];return[4,this.core.lock(t,function(){return h(J,void 0,void 0,function(){var r,s,a,c;return v(this,function(l){switch(l.label){case 0:return[4,this.core.get(t,i)];case 1:if((null==(r=l.sent())?void 0:r.optimistic)||(null==r?void 0:r.aborter)&&!o||((null==r?void 0:r.aborter)&&o&&r.aborter.abort("Replaced"),this.core.shouldCooldown(r)&&!u)||(s=null!==(c=null==r?void 0:r.data)&&void 0!==c?c:[],void 0===(a=e(S(s)))))return[2,{current:r,skip:!0}];return[4,this.core.mutate(t,r,function(t){return{time:null==t?void 0:t.time,aborter:n}},i)];case 2:return[2,{current:r=l.sent(),last:a}]}})})})];case 1:if(c=(a=q.sent()).current,l=a.skip,d=a.last,l)return[2,c];if(void 0===d)throw Error("Undefined last");b=void 0===(p=i.cooldown)?j:p,g=void 0===(w=i.expiration)?T:w,E=void 0===(x=i.timeout)?L:x,O=setTimeout(function(){n.abort("Scroll timed out")},E),q.label=2;case 2:return q.trys.push([2,6,9,10]),[4,r(d,{signal:D=n.signal})];case 3:if(I=(A=q.sent()).data,N=A.error,R=void 0===(P=A.time)?Date.now():P,C=void 0===(z=A.cooldown)?k(b):z,B=void 0===(U=A.expiration)?k(g):U,D.aborted)throw new _(D);return void 0!==B&&(null==c?void 0:c.expiration)!==void 0&&(B=Math.min(B,null==c?void 0:c.expiration)),[4,this.core.get(t,i)];case 4:return c=q.sent(),F={},void 0!==I&&(F.data=m(m([],y(null!==(s=null==c?void 0:c.data)&&void 0!==s?s:[]),!1),[I],!1)),F.error=N,[4,this.core.mutate(t,c,function(){return f({time:R,cooldown:C,expiration:B,aborter:void 0},F)},i)];case 5:case 8:return[2,q.sent()];case 6:return M=q.sent(),[4,this.core.get(t,i)];case 7:if((null==(c=q.sent())?void 0:c.aborter)!==n)return[2,c];return[4,this.core.mutate(t,c,function(){return{aborter:void 0,error:M}},i)];case 9:return clearTimeout(O),[7];case 10:return[2]}})})},t}();function z(t,e){if(void 0!==t){if("string"==typeof t)return t;var r=e.serializer;return"scroll:".concat((void 0===r?P:r).stringify(t))}}var C=function(){var t=function(t,e,r,n){void 0===n&&(n={}),this.core=t,this.scroller=e,this.fetcher=r,this.params=n,this.mparams=f(f({},t.params),n),this.key=e(),this.skey=z(this.key,this.mparams),this.loadSync(),this.subscribe()};return Object.defineProperty(t.prototype,"init",{get:function(){return this._init},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ready",{get:function(){return null!==this._state},enumerable:!1,configurable:!0}),t.prototype.loadSync=function(){var t=this.core,e=this.skey,r=this.mparams;this._state=t.getSync(e,r)},t.prototype.loadAsync=function(){return h(this,void 0,void 0,function(){var t,e,r,n,i;return v(this,function(o){switch(o.label){case 0:if(this.ready)return[2];return t=this,e=t.core,r=t.skey,n=t.mparams,i=this,[4,e.get(r,n)];case 1:return i._state=o.sent(),[2]}})})},t.prototype.subscribe=function(){var t=this,e=this.core,r=this.skey,n=function(e){return t._state=e};e.on(r,n),new FinalizationRegistry(function(){e.off(r,n)}).register(this,void 0)},t.prototype.mutate=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u;return v(this,function(s){switch(s.label){case 0:if(r=this,n=r.core,i=r.skey,o=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:s.sent(),s.label=2;case 2:if(null===this._state)throw Error("Null state after init");return u=this,[4,n.mutate(i,this._state,t,o)];case 3:return[2,u._state=s.sent()]}})})},t.prototype.fetch=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u,s,a;return v(this,function(c){switch(c.label){case 0:if(r=this,n=r.core,i=r.scroller,o=r.skey,u=r.fetcher,s=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:c.sent(),c.label=2;case 2:if(null===this._state)throw Error("Null state after init");if(void 0===u)return[2,this._state];return a=this,[4,n.scroll.first(o,i,u,t,s)];case 3:return[2,a._state=c.sent()]}})})},t.prototype.refetch=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u,s,a;return v(this,function(c){switch(c.label){case 0:if(r=this,n=r.core,i=r.scroller,o=r.skey,u=r.fetcher,s=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:c.sent(),c.label=2;case 2:if(null===this._state)throw Error("Null state after init");if(void 0===u)return[2,this._state];return a=this,[4,n.scroll.first(o,i,u,t,s,!0,!0)];case 3:return[2,a._state=c.sent()]}})})},t.prototype.scroll=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u,s,a;return v(this,function(c){switch(c.label){case 0:if(r=this,n=r.core,i=r.scroller,o=r.skey,u=r.fetcher,s=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:c.sent(),c.label=2;case 2:if(null===this._state)throw Error("Null state after init");if(void 0===u)return[2,this._state];return a=this,[4,n.scroll.scroll(o,i,u,t,s,!0,!0)];case 3:return[2,a._state=c.sent()]}})})},t.prototype.clear=function(){return h(this,void 0,void 0,function(){var t,e,r,n;return v(this,function(i){switch(i.label){case 0:return t=this,e=t.core,r=t.skey,n=t.mparams,[4,e.delete(r,n)];case 1:return i.sent(),delete this._state,[2]}})})},t}();function U(t,e,r){return void 0===r&&(r={}),new B(t,e,r)}var B=function(){var t=function(t,e,r){void 0===r&&(r={}),this.scroller=t,this.fetcher=e,this.params=r};return t.prototype.make=function(t){var e=this.scroller,r=this.fetcher,n=this.params;return new C(t,e,r,n)},t.prototype.normalize=function(t,e){return h(this,void 0,void 0,function(){var r,n,i,o,u,s;return v(this,function(u){switch(u.label){case 0:if(e.shallow)return[2];return n=(r=e.root).time,i=r.cooldown,s={data:t,time:n,cooldown:i,expiration:o=r.expiration,optimistic:r.optimistic},[4,this.make(e.core).mutate(function(){return s})];case 1:return u.sent(),[2]}})})},t}();function F(t){return h(this,void 0,void 0,function(){var e;return v(this,function(r){switch(r.label){case 0:return[4,t.next()];case 1:if((e=r.sent()).done)return[2,e.value];return[2]}})})}var M=function(){var t=function(t){this.core=t};return t.prototype.fetch=function(t,e,r,n,i,o,u){return void 0===n&&(n=new AbortController),void 0===i&&(i={}),void 0===o&&(o=!1),void 0===u&&(u=!1),h(this,void 0,void 0,function(){var s,a,c,l,d,p,y,m,b,w,g,S,x,E,O,D,A,I,N,P,R,z,C=this;return v(this,function(c){switch(c.label){case 0:if(void 0===t||void 0===e)return[2];return[4,this.core.lock(e,function(){return h(C,void 0,void 0,function(){var t;return v(this,function(r){switch(r.label){case 0:return[4,this.core.get(e,i)];case 1:if((null==(t=r.sent())?void 0:t.optimistic)||(null==t?void 0:t.aborter)&&!o||((null==t?void 0:t.aborter)&&o&&t.aborter.abort("Replaced"),this.core.shouldCooldown(t)&&!u))return[2,{current:t,skip:!0}];return[4,this.core.mutate(e,t,function(t){return{time:null==t?void 0:t.time,aborter:n}},i)];case 2:return[2,{current:t=r.sent()}]}})})})];case 1:if(a=(s=c.sent()).current,s.skip)return[2,a];d=void 0===(l=i.cooldown)?j:l,y=void 0===(p=i.expiration)?T:p,b=void 0===(m=i.timeout)?L:m,w=setTimeout(function(){n.abort("Fetch timed out")},b),c.label=2;case 2:return c.trys.push([2,6,9,10]),[4,r(t,{signal:g=n.signal})];case 3:if(x=(S=c.sent()).data,E=S.error,D=void 0===(O=S.time)?Date.now():O,I=void 0===(A=S.cooldown)?k(d):A,P=void 0===(N=S.expiration)?k(y):N,g.aborted)throw new _(g);return[4,this.core.get(e,i)];case 4:return a=c.sent(),R={},void 0!==x&&(R.data=x),R.error=E,[4,this.core.mutate(e,a,function(){return f({time:D,cooldown:I,expiration:P,aborter:void 0},R)},i)];case 5:case 8:return[2,c.sent()];case 6:return z=c.sent(),[4,this.core.get(e,i)];case 7:if((null==(a=c.sent())?void 0:a.aborter)!==n)return[2,a];return[4,this.core.mutate(e,a,function(){return{aborter:void 0,error:z}},i)];case 9:return clearTimeout(w),[7];case 10:return[2]}})})},t.prototype.update=function(t,e,r,n,i,o){var u,s;return void 0===i&&(i=new AbortController),void 0===o&&(o={}),h(this,void 0,void 0,function(){var a,c,l,d,p,y,m,w,g,S,x,E,O,D,A,I,N,P,R,z,C,U,B,M,J,q,W,X,H=this;return v(this,function(l){switch(l.label){case 0:if(void 0===t||void 0===e)return[2];return[4,this.core.lock(e,function(){return h(H,void 0,void 0,function(){var t;return v(this,function(r){switch(r.label){case 0:return[4,this.core.get(e,o)];case 1:if(null==(t=r.sent())?void 0:t.optimistic)return[2,{current:t,skip:!0}];return(null==t?void 0:t.aborter)&&t.aborter.abort("Replaced"),[4,this.core.mutate(e,t,function(t){return{time:null==t?void 0:t.time,aborter:i,optimistic:!0}},o)];case 2:return[2,{current:t=r.sent()}]}})})})];case 1:if(c=(a=l.sent()).current,a.skip)return[2,c];p=void 0===(d=o.cooldown)?j:d,m=void 0===(y=o.expiration)?T:y,g=void 0===(w=o.timeout)?L:w,S=setTimeout(function(){i.abort("Update timed out")},g),l.label=2;case 2:l.trys.push([2,23,26,27]),E=n(c,{signal:x=i.signal}),l.label=3;case 3:l.trys.push([3,9,10,15]),O=function(){var t,r,n,u;return v(this,function(s){switch(s.label){case 0:if(r=(t=I.value).data,n=t.error,x.aborted)throw new _(x);return u={},void 0!==r&&(u.data=r),u.error=n,[4,D.core.mutate(e,c,function(t){return f({time:null==t?void 0:t.time,aborter:i,optimistic:!0},u)},o)];case 1:return c=s.sent(),[2]}})},D=this,A=b(E),l.label=4;case 4:return[4,A.next()];case 5:if((I=l.sent()).done)return[3,8];return[5,O()];case 6:l.sent(),l.label=7;case 7:return[3,4];case 8:return[3,15];case 9:return u={error:l.sent()},[3,15];case 10:if(l.trys.push([10,,13,14]),!(I&&!I.done&&(s=A.return)))return[3,12];return[4,s.call(A)];case 11:l.sent(),l.label=12;case 12:return[3,14];case 13:if(u)throw u.error;return[7];case 14:return[7];case 15:return[4,F(E)];case 16:if(void 0!==(P=l.sent()))return[3,18];if(void 0===r)throw Error("Updater returned nothing and undefined fetcher");return[4,r(t,{signal:x,cache:"reload"})];case 17:P=l.sent(),l.label=18;case 18:if(R=P.data,z=P.error,U=void 0===(C=P.time)?Date.now():C,M=void 0===(B=P.cooldown)?k(p):B,q=void 0===(J=P.expiration)?k(m):J,x.aborted)throw new _(x);return[4,this.core.get(e,o)];case 19:if(c=l.sent(),!(void 0!==z))return[3,21];if((null==c?void 0:c.aborter)!==i)return[2,c];return[4,this.core.mutate(e,c,function(t){return{time:null==t?void 0:t.time,cooldown:M,expiration:q,aborter:void 0,optimistic:!1,data:null==t?void 0:t.data,error:z}},o)];case 20:case 22:case 25:return[2,l.sent()];case 21:return W={},void 0!==R&&(W.data=R),W.error=z,[4,this.core.mutate(e,c,function(){return f({time:U,cooldown:M,expiration:q,aborter:void 0,optimistic:!1},W)},o)];case 23:return X=l.sent(),[4,this.core.get(e,o)];case 24:if((null==(c=l.sent())?void 0:c.aborter)!==i)return[2,c];return[4,this.core.mutate(e,c,function(t){return{time:null==t?void 0:t.time,aborter:void 0,optimistic:!1,data:null==t?void 0:t.data,error:X}},o)];case 26:return clearTimeout(S),[7];case 27:return[2]}})})},t}();function J(t,e){if(void 0!==t){if("string"==typeof t)return t;var r=e.serializer;return(void 0===r?P:r).stringify(t)}}var q=function(){var t=function(t,e,r,n){void 0===n&&(n={}),this.core=t,this.key=e,this.fetcher=r,this.params=n,this.mparams=f(f({},t.params),n),this.skey=J(e,this.mparams),this.loadSync(),this.subscribe()};return Object.defineProperty(t.prototype,"init",{get:function(){return this._init},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ready",{get:function(){return null!==this._state},enumerable:!1,configurable:!0}),t.prototype.loadSync=function(){var t=this.core,e=this.skey,r=this.mparams;this._state=t.getSync(e,r)},t.prototype.loadAsync=function(){return h(this,void 0,void 0,function(){var t,e,r,n,i;return v(this,function(o){switch(o.label){case 0:if(this.ready)return[2];return t=this,e=t.core,r=t.skey,n=t.mparams,i=this,[4,e.get(r,n)];case 1:return i._state=o.sent(),[2]}})})},t.prototype.subscribe=function(){var t=this,e=this.core,r=this.skey,n=function(e){return t._state=e};e.on(this.skey,n),new FinalizationRegistry(function(){e.off(r,n)}).register(this,void 0)},t.prototype.mutate=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u;return v(this,function(s){switch(s.label){case 0:if(r=this,n=r.core,i=r.skey,o=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:s.sent(),s.label=2;case 2:if(null===this._state)throw Error("Null state after init");return u=this,[4,n.mutate(i,this._state,t,o)];case 3:return[2,u._state=s.sent()]}})})},t.prototype.fetch=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u,s,a;return v(this,function(c){switch(c.label){case 0:if(r=this,n=r.core,i=r.key,o=r.skey,u=r.fetcher,s=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:c.sent(),c.label=2;case 2:if(null===this._state)throw Error("Null state after init");if(void 0===u)return[2,this._state];return a=this,[4,n.single.fetch(i,o,u,t,s)];case 3:return[2,a._state=c.sent()]}})})},t.prototype.refetch=function(t){var e;return h(this,void 0,void 0,function(){var r,n,i,o,u,s,a;return v(this,function(c){switch(c.label){case 0:if(r=this,n=r.core,i=r.key,o=r.skey,u=r.fetcher,s=r.mparams,null!==this._state)return[3,2];return[4,null!==(e=this._init)&&void 0!==e?e:this._init=this.loadAsync()];case 1:c.sent(),c.label=2;case 2:if(null===this._state)throw Error("Null state after init");if(void 0===u)return[2,this._state];return a=this,[4,n.single.fetch(i,o,u,t,s,!0,!0)];case 3:return[2,a._state=c.sent()]}})})},t.prototype.update=function(t,e,r){var n;return void 0===e&&(e={}),h(this,void 0,void 0,function(){var i,o,u,s,a,c,l,d;return v(this,function(h){switch(h.label){case 0:if(i=this,o=i.core,u=i.key,s=i.skey,a=i.fetcher,c=i.mparams,null!==this._state)return[3,2];return[4,null!==(n=this._init)&&void 0!==n?n:this._init=this.loadAsync()];case 1:h.sent(),h.label=2;case 2:if(null===this._state)throw Error("Null state after init");return l=f(f({},c),e),d=this,[4,o.single.update(u,s,a,t,r,l)];case 3:return[2,d._state=h.sent()]}})})},t.prototype.clear=function(){return h(this,void 0,void 0,function(){var t,e,r,n;return v(this,function(i){switch(i.label){case 0:return t=this,e=t.core,r=t.skey,n=t.mparams,[4,e.delete(r,n)];case 1:return i.sent(),delete this._state,[2]}})})},t}();function W(t,e,r){return void 0===r&&(r={}),new X(t,e,r)}var X=function(){var t=function(t,e,r){void 0===r&&(r={}),this.key=t,this.fetcher=e,this.params=r};return t.prototype.make=function(t){var e=this.key,r=this.fetcher,n=this.params;return new q(t,e,r,n)},t.prototype.normalize=function(t,e){return h(this,void 0,void 0,function(){var r,n,i,o,u,s;return v(this,function(u){switch(u.label){case 0:if(e.shallow)return[2];return n=(r=e.root).time,i=r.cooldown,s={data:t,time:n,cooldown:i,expiration:o=r.expiration,optimistic:r.optimistic},[4,this.make(e.core).mutate(function(){return s})];case 1:return u.sent(),[2]}})})},t}();function H(t){return Boolean(t.async)}var K=function(){var t=function(){};return t.prototype.lock=function(t){return h(this,void 0,void 0,function(){var e;return v(this,function(r){switch(r.label){case 0:if(!this.mutex)return[3,2];return[4,this.mutex];case 1:r.sent(),r.label=2;case 2:return e=t(),this.mutex=e,[4,e];case 3:return[2,r.sent()]}})})},t}(),G=function(t){var e=function(e){var r=t.call(this)||this;return r.params=e,r.single=new M(r),r.scroll=new R(r),r.cache=new Map,r.locks=new Map,r._mounted=!0,r.counts=new Map,r.timeouts=new Map,r};return l(e,t),Object.defineProperty(e.prototype,"mounted",{get:function(){return this._mounted},enumerable:!1,configurable:!0}),e.prototype.unmount=function(){var t,e;try{for(var r=p(this.timeouts.values()),n=r.next();!n.done;n=r.next()){var i=n.value;clearTimeout(i)}}catch(o){t={error:o}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}this._mounted=!1},e.prototype.lock=function(t,e){return h(this,void 0,void 0,function(){var r,n;return v(this,function(i){switch(i.label){case 0:if(!(void 0!==(r=this.locks.get(t))))return[3,2];return[4,r.lock(e)];case 1:case 3:return[2,i.sent()];case 2:return n=new K,this.locks.set(t,n),[4,n.lock(e)]}})})},e.prototype.getSync=function(t,e){if(void 0===e&&(e={}),void 0!==t){var r=this.cache.get(t);if(void 0!==r)return r;var n=e.storage;if(n){if(H(n))return null;var i=n.get(t);return this.cache.set(t,i),i}}},e.prototype.get=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r=!1),h(this,void 0,void 0,function(){var n,i,o;return v(this,function(u){switch(u.label){case 0:if(void 0===t)return[2];if(void 0!==(n=this.cache.get(t)))return[2,n];if(!(i=e.storage))return[2];return[4,i.get(t,r)];case 1:return o=u.sent(),this.cache.set(t,o),[2,o]}})})},e.prototype.set=function(t,e,r){return void 0===r&&(r={}),h(this,void 0,void 0,function(){var n,i,o,u,s;return v(this,function(a){switch(a.label){case 0:if(void 0===t||(this.cache.set(t,e),this.publish(t,e),!(n=r.storage)))return[2];return i=e.data,o=e.time,u=e.cooldown,s=e.expiration,[4,n.set(t,{data:i,time:o,cooldown:u,expiration:s})];case 1:return a.sent(),[2]}})})},e.prototype.delete=function(t,e){return void 0===e&&(e={}),h(this,void 0,void 0,function(){var r;return v(this,function(n){switch(n.label){case 0:if(!t||(this.cache.delete(t),this.locks.delete(t),this.publish(t,void 0),!(r=e.storage)))return[2];return[4,r.delete(t)];case 1:return n.sent(),[2]}})})},e.prototype.mutate=function(t,e,r,n){var i;return void 0===n&&(n={}),h(this,void 0,void 0,function(){var o,u,s,a,c;return v(this,function(l){switch(l.label){case 0:if(void 0===t)return[2];if(o=r(e))return[3,2];return[4,this.delete(t,n)];case 1:return l.sent(),[2];case 2:if(void 0!==o.time&&o.time<(null!==(i=null==e?void 0:e.time)&&void 0!==i?i:0)||void 0===o.optimistic&&(null==e?void 0:e.optimistic))return[2,e];return s=void 0===(u=n.equals)?N:u,c=a=f(f({},e),o),[4,this.normalize(!1,a,n)];case 3:if(c.data=l.sent(),void 0===a.time&&(a.time=Date.now()),s(a.data,null==e?void 0:e.data)&&(a.data=null==e?void 0:e.data),a.optimistic||(a.realData=a.data),I(a,e))return[2,e];return[4,this.set(t,a,n)];case 4:return l.sent(),[2,a]}})})},e.prototype.normalize=function(t,e,r){return void 0===r&&(r={}),h(this,void 0,void 0,function(){return v(this,function(n){switch(n.label){case 0:if(void 0===e.data)return[2];if(void 0===r.normalizer)return[2,e.data];return[4,r.normalizer(e.data,{core:this,shallow:t,root:e})];case 1:return[2,n.sent()]}})})},e.prototype.shouldCooldown=function(t){return(null==t?void 0:t.cooldown)!==void 0&&Date.now()<t.cooldown},e.prototype.once=function(t,e,r){var n=this;if(void 0===r&&(r={}),t){var i=function(o){n.off(t,i,r),e(o)};this.on(t,i,r)}},e.prototype.on=function(e,r,n){if(e){t.prototype.on.call(this,e,r);var i,o=null!==(i=this.counts.get(e))&&void 0!==i?i:0;this.counts.set(e,o+1);var u=this.timeouts.get(e);void 0!==u&&(clearTimeout(u),this.timeouts.delete(e))}},e.prototype.off=function(e,r,n){return void 0===n&&(n={}),h(this,void 0,void 0,function(){var i,o,u,s,a,c=this;return v(this,function(s){switch(s.label){case 0:if(!e)return[2];if(t.prototype.off.call(this,e,r),void 0===(i=this.counts.get(e)))throw Error("Undefined count");if(i>1)return this.counts.set(e,i-1),[2];return this.counts.delete(e),[4,this.get(e,n,!0)];case 1:if((null==(o=s.sent())?void 0:o.expiration)===void 0||(null==o?void 0:o.expiration)===-1)return[2];if(u=function(){return h(c,void 0,void 0,function(){var t;return v(this,function(t){switch(t.label){case 0:if(!this._mounted||void 0!==this.counts.get(e))return[2];return this.timeouts.delete(e),[4,this.delete(e,n)];case 1:return t.sent(),[2]}})})},!(Date.now()>o.expiration))return[3,3];return[4,u()];case 2:return s.sent(),[2];case 3:return a=setTimeout(u,o.expiration-Date.now()),this.timeouts.set(e,a),[2]}})})},e}(g),Q=e(void 0);function V(){var t=r(Q);if(void 0===t)throw Error("Undefined core");return t}function Z(t){var e=n();return void 0===e.current&&(e.current=new G(t)),i(function(){return function(){var t;null===(t=e.current)||void 0===t||t.unmount()}},[]),e.current}function Y(e){var r=e.children,n=d(e,["children"]),i=Z(n);return t.createElement(Q.Provider,{value:i},r)}function $(t,e){var r=t.data;i(function(){console.debug(e,t)},[r,t.error,t.time])}function tt(t,e){var r=t.error;i(function(){void 0!==r&&e(r)},[r])}function te(t,e){var r=t.data,n=t.error;void 0===r&&void 0===n&&Object.assign(t,e)}function tr(t){var e=t.fetch;i(function(){e()},[e])}function tn(t,e){var r=t.ready,n=t.fetch;i(function(){if(r&&e){var t=setInterval(n,e);return function(){return clearInterval(t)}}},[n,e])}function ti(t){var e=t.fetch;i(function(){e()},[])}function to(t){var e=t.data,r=t.fetch;i(function(){void 0===e&&r()},[e,r])}function tu(t){var e=n(t);return e.current=t,e}function ts(t){var e=t.ready,r=tu(t.fetch);i(function(){if(e){var t=function(){return r.current()};return addEventListener("online",t),function(){return removeEventListener("online",t)}}},[e])}function ta(t,e){void 0===e&&(e={});var r=t.ready,o=t.skey,u=t.refetch,s=t.error,a=e.init,c=void 0===a?1e3:a,l=e.base,f=void 0===l?2:l,d=e.max,h=void 0===d?3:d,v=n(0);i(function(){v.current=0},[o]);var p=tu(u);i(function(){var t=function(){v.current++,p.current()};if(r){if(void 0===s){v.current=0;return}if(!(v.current>=h)){var e=setTimeout(t,c*Math.pow(f,v.current));return function(){return clearTimeout(e)}}}},[r,s])}function tc(t){var e=t.ready,r=tu(t.fetch);i(function(){if(e){var t=function(){return!document.hidden&&r.current()};return document.addEventListener("visibilitychange",t),function(){return document.removeEventListener("visibilitychange",t)}}},[e])}function tl(t,e,r){var a=this;void 0===r&&(r={});var c=V(),l=f(f({},c.params),r),d=tu(t),p=tu(e),m=tu(l),b=o(function(){return t()},[t]),w=o(function(){return z(b,m.current)},[b]),g=y(u(0),2)[1],S=n();o(function(){S.current=c.getSync(w,m.current)},[c,w]);var k=s(function(t){S.current=t,g(function(t){return t+1})},[]),x=n();i(function(){null===S.current&&(x.current=c.get(w,m.current).then(k))},[c,w]),i(function(){if(w)return c.on(w,k,m.current),function(){c.off(w,k,m.current)}},[c,w]);var _=s(function(t){return h(a,void 0,void 0,function(){var e,r;return v(this,function(n){switch(n.label){case 0:if(null!==S.current)return[3,2];return[4,x.current];case 1:n.sent(),n.label=2;case 2:if(null===S.current)throw Error("Null state after init");return e=S.current,r=m.current,[4,c.mutate(w,e,t,r)];case 3:return[2,n.sent()]}})})},[c,w]),E=s(function(){return h(a,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:if(null!==S.current)return[3,2];return[4,x.current];case 1:t.sent(),t.label=2;case 2:if(null===S.current)throw Error("Null state after init");return[4,c.delete(w,m.current)];case 3:return t.sent(),[2]}})})},[c,w]),O=s(function(t){return h(a,void 0,void 0,function(){var e,r,n;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof window)throw Error("Fetch on SSR");if(null!==S.current)return[3,2];return[4,x.current];case 1:i.sent(),i.label=2;case 2:if(null===S.current)throw Error("Null state after init");if(void 0===p.current)return[2,S.current];return e=d.current,r=p.current,n=m.current,[4,c.scroll.first(w,e,r,t,n)];case 3:return[2,i.sent()]}})})},[c,w]),D=s(function(t){return h(a,void 0,void 0,function(){var e,r,n;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof window)throw Error("Refetch on SSR");if(null!==S.current)return[3,2];return[4,x.current];case 1:i.sent(),i.label=2;case 2:if(null===S.current)throw Error("Null state after init");if(void 0===p.current)return[2,S.current];return e=d.current,r=p.current,n=m.current,[4,c.scroll.first(w,e,r,t,n,!0,!0)];case 3:return[2,i.sent()]}})})},[c,w]),A=s(function(t){return h(a,void 0,void 0,function(){var e,r,n;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof window)throw Error("Scroll on SSR");if(null!==S.current)return[3,2];return[4,x.current];case 1:i.sent(),i.label=2;case 2:if(null===S.current)throw Error("Null state after init");if(void 0===p.current)return[2,S.current];return e=d.current,r=p.current,n=m.current,[4,c.scroll.scroll(w,e,r,t,n,!0,!0)];case 3:return[2,i.sent()]}})})},[c,w]),I=s(function(){if("undefined"==typeof window)throw Error("Suspend on SSR");return h(a,void 0,void 0,function(){var t,e,r,n;return v(this,function(i){switch(i.label){case 0:if(null!==S.current)return[3,2];return[4,x.current];case 1:i.sent(),i.label=2;case 2:if(null===S.current)throw Error("Null state after init");if(void 0===p.current)throw Error("No fetcher");return t=d.current,e=p.current,r=m.current,n=new Promise(function(t){return c.once(w,function(){return t()},r)}),[4,c.scroll.first(w,t,e,void 0,r,!1,!0)];case 3:return i.sent(),[4,n];case 4:return i.sent(),[2]}})})},[c,w]),N=S.current,P=null!=N?N:{},j=P.data,T=P.error,L=P.time,R=P.cooldown,C=P.expiration,U=P.aborter,B=P.optimistic,F=P.realData,M=Boolean(U);return{key:b,skey:w,data:j,error:T,time:L,cooldown:R,expiration:C,aborter:U,optimistic:B,realData:F,loading:M,ready:null!==N,mutate:_,fetch:O,refetch:D,scroll:A,clear:E,suspend:I}}function tf(t,e,r){var a=this;void 0===r&&(r={});var c=V(),l=f(f({},c.params),r),d=tu(t),p=tu(e),m=tu(l),b=o(function(){return J(t,m.current)},[t]),w=y(u(0),2)[1],g=n();o(function(){g.current=c.getSync(b,m.current)},[c,b]);var S=s(function(t){g.current=t,w(function(t){return t+1})},[]),k=n();i(function(){null===g.current&&(k.current=c.get(b,m.current).then(S))},[c,b]),i(function(){if(b)return c.on(b,S,m.current),function(){c.off(b,S,m.current)}},[c,b]);var x=s(function(t){return h(a,void 0,void 0,function(){var e,r;return v(this,function(n){switch(n.label){case 0:if(null!==g.current)return[3,2];return[4,k.current];case 1:n.sent(),n.label=2;case 2:if(null===g.current)throw Error("Null state after init");return e=g.current,r=m.current,[4,c.mutate(b,e,t,r)];case 3:return[2,n.sent()]}})})},[c,b]),_=s(function(){return h(a,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:if(null!==g.current)return[3,2];return[4,k.current];case 1:t.sent(),t.label=2;case 2:if(null===g.current)throw Error("Null state after init");return[4,c.delete(b,m.current)];case 3:return t.sent(),[2]}})})},[c,b]),E=s(function(t){return h(a,void 0,void 0,function(){var e,r,n;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof window)throw Error("Fetch on SSR");if(null!==g.current)return[3,2];return[4,k.current];case 1:i.sent(),i.label=2;case 2:if(null===g.current)throw Error("Null state after init");if(void 0===p.current)return[2,g.current];return e=d.current,r=p.current,n=m.current,[4,c.single.fetch(e,b,r,t,n)];case 3:return[2,i.sent()]}})})},[c,b]),O=s(function(t){return h(a,void 0,void 0,function(){var e,r,n;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof window)throw Error("Refetch on SSR");if(null!==g.current)return[3,2];return[4,k.current];case 1:i.sent(),i.label=2;case 2:if(null===g.current)throw Error("Null state after init");if(void 0===p.current)return[2,g.current];return e=d.current,r=p.current,n=m.current,[4,c.single.fetch(e,b,r,t,n,!0,!0)];case 3:return[2,i.sent()]}})})},[c,b]),D=s(function(t,e,r){return void 0===e&&(e={}),h(a,void 0,void 0,function(){var n,i,o,u;return v(this,function(o){switch(o.label){case 0:if("undefined"==typeof window)throw Error("Update on SSR");if(null!==g.current)return[3,2];return[4,k.current];case 1:o.sent(),o.label=2;case 2:if(null===g.current)throw Error("Null state after init");return n=d.current,i=p.current,u=f(f({},m.current),e),[4,c.single.update(n,b,i,t,r,u)];case 3:return[2,o.sent()]}})})},[c,b]),A=s(function(){if("undefined"==typeof window)throw Error("Suspend on SSR");return h(a,void 0,void 0,function(){var t,e,r,n;return v(this,function(i){switch(i.label){case 0:if(null!==g.current)return[3,2];return[4,k.current];case 1:i.sent(),i.label=2;case 2:if(null===g.current)throw Error("Null state after init");if(void 0===p.current)throw Error("No fetcher");return t=d.current,e=p.current,r=m.current,n=new Promise(function(t){return c.once(b,function(){return t()},r)}),[4,c.single.fetch(t,b,e,void 0,r,!1,!0)];case 3:return i.sent(),[4,n];case 4:return i.sent(),[2]}})})},[c,b]),I=g.current,N=null!=I?I:{},P=N.data,j=N.error,T=N.time,L=N.cooldown,R=N.expiration,z=N.aborter,C=N.optimistic,U=N.realData,B=Boolean(z);return{key:t,skey:b,data:P,error:j,time:T,cooldown:L,expiration:R,aborter:z,optimistic:C,realData:U,loading:B,ready:null!==I,mutate:x,fetch:E,refetch:O,update:D,clear:_,suspend:A}}function td(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function th(t,e){var r=o(function(){return t.apply(void 0,m([],y(e),!1))},e);if(td(r,X)){var n=r.key,i=r.fetcher,u=r.params;return tf(n,i,u)}if(td(r,B)){var s=r.scroller,i=r.fetcher,u=r.params;return tl(s,i,u)}throw Error("Invalid resource schema")}function tv(){var t=V(),e=s(function(e){return e.make(t)},[t]);return{core:t,make:e}}function tp(t){var e=n();return void 0===e.current&&(e.current=new ty(t)),i(function(){return function(){var t;null===(t=e.current)||void 0===t||t.unmount()}},[]),e.current}var ty=function(){var t=function(t){var e=this;this.name=t,this.async=!0,this.keys=new Set,"undefined"!=typeof indexedDB&&(this.initialization=this.load(),this.onunload=function(){return e.unload()},addEventListener("beforeunload",this.onunload))};return Object.defineProperty(t.prototype,"database",{get:function(){return this._database},enumerable:!1,configurable:!0}),t.prototype.load=function(){return h(this,void 0,void 0,function(){var t,e,r,n=this;return v(this,function(r){switch(r.label){case 0:if("undefined"==typeof indexedDB)return[2];return t=this,[4,new Promise(function(t,e){var r=indexedDB.open(n.name,1);r.onupgradeneeded=function(){return r.result.createObjectStore("keyval",{})},r.onblocked=function(){return e("blocked")},r.onsuccess=function(){return t(r.result)},r.onerror=function(){return e(r.error)}})];case 1:if(t._database=r.sent(),"undefined"==typeof Storage||!(e=localStorage.getItem("idb.".concat(this.name,".keys"))))return[2];return JSON.parse(e).forEach(function(t){return n.keys.add(t)}),localStorage.removeItem("idb.".concat(this.name,".keys")),[4,this.collect().catch(console.error)];case 2:return r.sent(),[2]}})})},t.prototype.unmount=function(){"undefined"!=typeof indexedDB&&(void 0!==this.onunload&&removeEventListener("beforeunload",this.onunload),this.collect().catch(console.error))},t.prototype.unload=function(){if("undefined"!=typeof Storage){var t=JSON.stringify(m([],y(this.keys),!1));localStorage.setItem("idb.".concat(this.name,".keys"),t)}},t.prototype.collect=function(){return h(this,void 0,void 0,function(){var t,e,r,n,i,o,u;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof indexedDB)return[2];i.label=1;case 1:i.trys.push([1,6,7,8]),e=(t=p(this.keys)).next(),i.label=2;case 2:if(e.done)return[3,5];return r=e.value,[4,this.get(r,!0)];case 3:if((null==(n=i.sent())?void 0:n.expiration)===void 0||n.expiration>Date.now())return[3,4];this.delete(r,!1),i.label=4;case 4:return e=t.next(),[3,2];case 5:return[3,8];case 6:return o={error:i.sent()},[3,8];case 7:try{e&&!e.done&&(u=t.return)&&u.call(t)}finally{if(o)throw o.error}return[7];case 8:return[2]}})})},t.prototype.transact=function(t,e){return h(this,void 0,void 0,function(){var r=this;return v(this,function(n){switch(n.label){case 0:if("undefined"==typeof indexedDB)return[2];if(void 0!==this.database)return[3,2];return[4,this.initialization];case 1:n.sent(),n.label=2;case 2:return[4,new Promise(function(n,i){if(void 0===r.database)throw Error("Undefined database");var o,u=r.database.transaction("keyval",e);u.onerror=function(){return i(u.error)},u.oncomplete=function(){return n(o)},t(u.objectStore("keyval")).then(function(t){return o=t}).then(function(){return u.commit()}).catch(i)})];case 3:return[2,n.sent()]}})})},t.prototype.get=function(t,e){return void 0===e&&(e=!1),h(this,void 0,void 0,function(){var r=this;return v(this,function(n){switch(n.label){case 0:if("undefined"==typeof indexedDB)return[2];return e||this.keys.has(t)||this.keys.add(t),[4,this.transact(function(e){return h(r,void 0,void 0,function(){return v(this,function(r){switch(r.label){case 0:return[4,new Promise(function(r,n){var i=e.get(t);i.onerror=function(){return n(i.error)},i.onsuccess=function(){return r(i.result)}})];case 1:return[2,r.sent()]}})})},"readonly")];case 1:return[2,n.sent()]}})})},t.prototype.set=function(t,e,r){return void 0===r&&(r=!1),h(this,void 0,void 0,function(){var n=this;return v(this,function(i){switch(i.label){case 0:if("undefined"==typeof indexedDB)return[2];return r||this.keys.has(t)||this.keys.add(t),[4,this.transact(function(r){return h(n,void 0,void 0,function(){return v(this,function(n){switch(n.label){case 0:return[4,new Promise(function(n,i){var o=r.put(e,t);o.onerror=function(){return i(o.error)},o.onsuccess=function(){return n()}})];case 1:return[2,n.sent()]}})})},"readwrite")];case 1:return[2,i.sent()]}})})},t.prototype.delete=function(t,e){return void 0===e&&(e=!1),h(this,void 0,void 0,function(){var r=this;return v(this,function(n){switch(n.label){case 0:if("undefined"==typeof indexedDB)return[2];return!e&&this.keys.has(t)&&this.keys.delete(t),[4,this.transact(function(e){return h(r,void 0,void 0,function(){return v(this,function(r){switch(r.label){case 0:return[4,new Promise(function(r,n){var i=e.delete(t);i.onerror=function(){return n(i.error)},i.onsuccess=function(){return r()}})];case 1:return[2,r.sent()]}})})},"readwrite")];case 1:return[2,n.sent()]}})})},t}();function tm(t,e){var r=n();return void 0===r.current&&(r.current=new tb(t,e)),i(function(){return function(){var t;null===(t=r.current)||void 0===t||t.unmount()}},[]),r.current}var tb=function(){var t=function(t,e){void 0===t&&(t="xswr:"),void 0===e&&(e=JSON);var r=this;this.prefix=t,this.serializer=e,this.async=!0,this.keys=new Set,"undefined"!=typeof Storage&&(this.onunload=function(){return r.collect()},addEventListener("beforeunload",this.onunload))};return t.prototype.unmount=function(){"undefined"!=typeof Storage&&(this.onunload&&removeEventListener("beforeunload",this.onunload),h(this,void 0,void 0,function(){return v(this,function(t){return[2,this.collect()]})}).catch(console.error))},t.prototype.collect=function(){var t,e;if("undefined"!=typeof Storage)try{for(var r=p(this.keys),n=r.next();!n.done;n=r.next()){var i=n.value,o=this.getSync(i,!0);(null==o?void 0:o.expiration)!==void 0&&(o.expiration>Date.now()||this.delete(i,!1))}}catch(u){t={error:u}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.getSync=function(t,e){if(void 0===e&&(e=!1),"undefined"!=typeof Storage){e||this.keys.has(t)||this.keys.add(t);var r=localStorage.getItem(this.prefix+t);if(r)return this.serializer.parse(r)}},t.prototype.get=function(t,e){return void 0===e&&(e=!1),h(this,void 0,void 0,function(){var r;return v(this,function(n){return"undefined"==typeof Storage?[2]:(e||this.keys.has(t)||this.keys.add(t),r=localStorage.getItem(this.prefix+t))?[2,this.serializer.parse(r)]:[2]})})},t.prototype.set=function(t,e,r){return void 0===r&&(r=!1),h(this,void 0,void 0,function(){var n;return v(this,function(i){return"undefined"==typeof Storage||(r||this.keys.has(t)||this.keys.add(t),n=this.serializer.stringify(e),localStorage.setItem(this.prefix+t,n)),[2]})})},t.prototype.delete=function(t,e){return void 0===e&&(e=!1),h(this,void 0,void 0,function(){return v(this,function(r){return"undefined"==typeof Storage||(!e&&this.keys.has(t)&&this.keys.delete(t),localStorage.removeItem(this.prefix+t)),[2]})})},t}();function tw(t,e){var r=n();return r.current||(r.current=new tg(t,e)),i(function(){return function(){var t;null===(t=r.current)||void 0===t||t.unmount()}},[]),r.current}var tg=function(){var t=function(t,e){void 0===t&&(t="xswr:"),void 0===e&&(e=JSON);var r=this;this.prefix=t,this.serializer=e,this.async=!1,this.keys=new Set,"undefined"!=typeof Storage&&(this.onunload=function(){return r.collect()},addEventListener("beforeunload",this.onunload))};return t.prototype.unmount=function(){"undefined"!=typeof Storage&&(removeEventListener("beforeunload",this.onunload),h(this,void 0,void 0,function(){return v(this,function(t){return[2,this.collect()]})}).catch(console.error))},t.prototype.collect=function(){var t,e;if("undefined"!=typeof Storage)try{for(var r=p(this.keys),n=r.next();!n.done;n=r.next()){var i=n.value,o=this.get(i,!0);(null==o?void 0:o.expiration)!==void 0&&(o.expiration>Date.now()||this.delete(i,!1))}}catch(u){t={error:u}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.get=function(t,e){if(void 0===e&&(e=!1),"undefined"!=typeof Storage){e||this.keys.has(t)||this.keys.add(t);var r=localStorage.getItem(this.prefix+t);if(r)return this.serializer.parse(r)}},t.prototype.set=function(t,e,r){if(void 0===r&&(r=!1),"undefined"!=typeof Storage){r||this.keys.has(t)||this.keys.add(t);var n=this.serializer.stringify(e);localStorage.setItem(this.prefix+t,n)}},t.prototype.delete=function(t,e){void 0===e&&(e=!1),"undefined"!=typeof Storage&&(!e&&this.keys.has(t)&&this.keys.delete(t),localStorage.removeItem(this.prefix+t))},t}(),tS={__proto__:null,Core:G,AbortError:_,isAbortError:E,CoreContext:Q,useCore:V,useCoreProvider:Z,CoreProvider:Y,useDebug:$,useError:tt,useFallback:te,useFetch:tr,useInterval:tn,useMount:ti,useOnce:to,useOnline:ts,useRetry:ta,useVisible:tc,use:th,useScroll:tl,useSingle:tf,useXSWR:tv,ScrollHelper:R,getScrollStorageKey:z,ScrollObject:C,scroll:U,ScrollSchema:B,SingleHelper:M,getSingleStorageKey:J,SingleObject:q,single:W,SingleSchema:X,useIDBStorage:tp,IDBStorage:ty,useAsyncLocalStorage:tm,AsyncLocalStorage:tb,useSyncLocalStorage:tw,SyncLocalStorage:tg,isAsyncStorage:H,DEFAULT_EQUALS:N,DEFAULT_SERIALIZER:P,DEFAULT_COOLDOWN:j,DEFAULT_EXPIRATION:T,DEFAULT_TIMEOUT:L,refEquals:D,jsonEquals:A,shallowEquals:I};export{tS as XSWR};
