{"version":3,"file":"sync.js","sources":["../../../../../src/mods/storages/localStorage/sync.ts"],"sourcesContent":["import { Serializer } from \"mods/types/serializer.js\"\nimport { State } from \"mods/types/state.js\"\nimport { SyncStorage } from \"mods/types/storage.js\"\nimport { useEffect, useRef } from \"react\"\n\n/**\n * Synchronous local storage\n * \n * Do NOT use with SSR, it will create hydratation errors\n * Do NOT use for storing large objects, it will harm performances\n * \n * Will display data on first render\n * \n * @see AsyncLocalStorage\n */\nexport function useSyncLocalStorage(prefix?: string, serializer?: Serializer) {\n  const storage = useRef<SyncLocalStorage>()\n\n  if (!storage.current)\n    storage.current = new SyncLocalStorage(prefix, serializer)\n\n  useEffect(() => () => {\n    storage.current?.unmount()\n  }, [])\n\n  return storage.current\n}\n\n/**\n * Synchronous local storage\n * \n * Do NOT use with SSR, it will create hydratation errors\n * Do NOT use for storing large objects, it will harm performances\n * \n * Will display data on first render\n * \n * @see AsyncLocalStorage\n */\nexport class SyncLocalStorage implements SyncStorage {\n  readonly async = false\n  readonly keys = new Set<string>()\n  readonly onunload?: () => void\n\n  constructor(\n    readonly prefix = \"xswr:\",\n    readonly serializer: Serializer = JSON\n  ) {\n    if (typeof Storage === \"undefined\")\n      return\n    this.onunload = () => this.collect()\n    addEventListener(\"beforeunload\", this.onunload)\n  }\n\n  unmount() {\n    if (typeof Storage === \"undefined\")\n      return\n    removeEventListener(\"beforeunload\", this.onunload!);\n    (async () => this.collect())().catch(console.error)\n  }\n\n  collect() {\n    if (typeof Storage === \"undefined\")\n      return\n    for (const key of this.keys) {\n      const state = this.get<State>(key, true)\n      if (state?.expiration === undefined) continue\n      if (state.expiration > Date.now()) continue\n      this.delete(key, false)\n    }\n  }\n\n  get<T = any>(key: string, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && !this.keys.has(key))\n      this.keys.add(key)\n    const item = localStorage.getItem(this.prefix + key)\n    if (item) return this.serializer.parse(item) as T\n  }\n\n  set<T = any>(key: string, value: T, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && !this.keys.has(key))\n      this.keys.add(key)\n    const item = this.serializer.stringify(value)\n    localStorage.setItem(this.prefix + key, item)\n  }\n\n  delete(key: string, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && this.keys.has(key))\n      this.keys.delete(key)\n    localStorage.removeItem(this.prefix + key)\n  }\n}"],"names":[],"mappings":"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"}