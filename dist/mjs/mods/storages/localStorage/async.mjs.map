{"version":3,"file":"async.mjs","sources":["../../../../../src/mods/storages/localStorage/async.ts"],"sourcesContent":["import { Serializer } from \"mods/types/serializer.js\"\nimport { State } from \"mods/types/state.js\"\nimport { AsyncStorage } from \"mods/types/storage.js\"\nimport { useEffect, useRef } from \"react\"\n\n/**\n * Asynchronous local storage\n * \n * Use for compatibility with SSR\n * Use for storing large objects\n * \n * Won't display data on first render or hydratation, you can either:\n * - use SyncLocalStorage\n * - use useFallback\n * \n * @see SyncLocalStorage\n * @see useFallback\n */\nexport function useAsyncLocalStorage(prefix?: string, serializer?: Serializer) {\n  const storage = useRef<AsyncLocalStorage>()\n\n  if (storage.current === undefined)\n    storage.current = new AsyncLocalStorage(prefix, serializer)\n\n  useEffect(() => () => {\n    storage.current?.unmount()\n  }, [])\n\n  return storage.current\n}\n\n/**\n * Asynchronous local storage\n * \n * Use for compatibility with SSR\n * Use for storing large objects\n * \n * Won't display data on first render or hydratation, you can either:\n * - use SyncLocalStorage\n * - use useFallback\n * \n * @see SyncLocalStorage\n * @see useFallback\n */\nexport class AsyncLocalStorage implements AsyncStorage {\n  readonly async = true\n  readonly keys = new Set<string>()\n  readonly onunload?: () => void\n\n  constructor(\n    readonly prefix = \"xswr:\",\n    readonly serializer: Serializer = JSON\n  ) {\n    if (typeof Storage === \"undefined\")\n      return\n    this.onunload = () => this.collect()\n    addEventListener(\"beforeunload\", this.onunload)\n  }\n\n  unmount() {\n    if (typeof Storage === \"undefined\")\n      return\n    if (this.onunload)\n      removeEventListener(\"beforeunload\", this.onunload);\n    (async () => this.collect())().catch(console.error)\n  }\n\n  collect() {\n    if (typeof Storage === \"undefined\")\n      return\n    for (const key of this.keys) {\n      const state = this.getSync<State>(key, true)\n      if (state?.expiration === undefined) continue\n      if (state.expiration > Date.now()) continue\n      this.delete(key, false)\n    }\n  }\n\n  getSync<T = any>(key: string, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && !this.keys.has(key))\n      this.keys.add(key)\n    const item = localStorage.getItem(this.prefix + key)\n    if (item) return this.serializer.parse(item) as T\n  }\n\n  async get<T = any>(key: string, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && !this.keys.has(key))\n      this.keys.add(key)\n    const item = localStorage.getItem(this.prefix + key)\n    if (item) return this.serializer.parse(item) as T\n  }\n\n  async set<T = any>(key: string, value: T, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && !this.keys.has(key))\n      this.keys.add(key)\n    const item = this.serializer.stringify(value)\n    localStorage.setItem(this.prefix + key, item)\n  }\n\n  async delete(key: string, ignore = false) {\n    if (typeof Storage === \"undefined\")\n      return\n    if (!ignore && this.keys.has(key))\n      this.keys.delete(key)\n    localStorage.removeItem(this.prefix + key)\n  }\n}"],"names":[],"mappings":"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"}