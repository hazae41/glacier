{"version":3,"file":"object.mjs","sources":["../../../../src/mods/single/object.ts"],"sourcesContent":["import { Core } from \"mods/core.js\";\nimport { Fetcher } from \"mods/types/fetcher.js\";\nimport { Mutator } from \"mods/types/mutator.js\";\nimport { Object } from \"mods/types/object.js\";\nimport { Params } from \"mods/types/params.js\";\nimport { State } from \"mods/types/state.js\";\nimport { Updater, UpdaterParams } from \"mods/types/updater.js\";\nimport { DEFAULT_SERIALIZER } from \"mods/utils/defaults.js\";\n\nexport function getSingleStorageKey<D = any, E = any, K = any>(key: K, params: Params) {\n  if (key === undefined)\n    return undefined\n  if (typeof key === \"string\")\n    return key\n\n  const {\n    serializer = DEFAULT_SERIALIZER\n  } = params\n\n  return serializer.stringify(key)\n}\n\n/**\n * Non-React version of SingleHandle\n */\nexport class SingleObject<D = any, E = any, K = any> implements Object<D, E, K>{\n  readonly skey: string | undefined\n  readonly mparams: Params<D, E, K>\n\n  private _init: Promise<void> | undefined\n  private _state: State<D, E, K> | undefined | null\n\n  constructor(\n    readonly core: Core,\n    readonly key: K | undefined,\n    readonly fetcher: Fetcher<D, E, K> | undefined,\n    readonly params: Params<D, E, K> = {},\n  ) {\n    this.mparams = { ...core.params, ...params }\n\n    this.skey = getSingleStorageKey(key, this.mparams)\n\n    this.loadSync()\n    this.subscribe()\n  }\n\n  get init() { return this._init }\n  get state() { return this._state }\n  get ready() { return this._state !== null }\n\n  private loadSync() {\n    const { core, skey, mparams } = this\n\n    this._state = core.getSync(skey, mparams)\n  }\n\n  private async loadAsync() {\n    if (this.ready) return\n\n    const { core, skey, mparams } = this\n\n    this._state = await core.get(skey, mparams)\n  }\n\n  private subscribe() {\n    const { core, skey } = this\n\n    const setter = (state?: State<D, E, K>) =>\n      this._state = state\n\n    core.on(this.skey, setter)\n\n    new FinalizationRegistry(() => {\n      core.off(skey, setter)\n    }).register(this, undefined)\n  }\n\n  async mutate(mutator: Mutator<D, E, K>) {\n    const { core, skey, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n\n    return this._state = await core.mutate(skey, this._state, mutator, mparams)\n  }\n\n  async fetch(aborter?: AbortController) {\n    const { core, key, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n    if (fetcher === undefined)\n      return this._state\n\n    return this._state = await core.single.fetch(key, skey, fetcher, aborter, mparams)\n  }\n\n  async refetch(aborter?: AbortController) {\n    const { core, key, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n    if (fetcher === undefined)\n      return this._state\n\n    return this._state = await core.single.fetch(key, skey, fetcher, aborter, mparams, true, true)\n  }\n\n  async update(updater: Updater<D, E, K>, uparams: UpdaterParams<D, E, K> = {}, aborter?: AbortController) {\n    const { core, key, skey, fetcher, mparams } = this\n\n    if (this._state === null)\n      await (this._init ??= this.loadAsync())\n    if (this._state === null)\n      throw new Error(\"Null state after init\")\n\n    const fparams = { ...mparams, ...uparams }\n\n    return this._state = await core.single.update(key, skey, fetcher, updater, aborter, fparams)\n  }\n\n  async clear() {\n    const { core, skey, mparams } = this\n\n    await core.delete(skey, mparams)\n    delete this._state\n  }\n}"],"names":[],"mappings":"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"}